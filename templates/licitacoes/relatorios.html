{% extends 'base.html' %}
{% load humanize %}

{% block title %}Relat칩rios - LicitOn{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    /* --- CSS ATUALIZADO --- */
    
    /* 츼rea dos Filtros */
    .report-controls {
        background: white; 
        padding: 20px; 
        border-radius: 8px; 
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
    }

    /* Layout Flex para alinhar inputs e bot칚o */
    .form-row { 
        display: flex; 
        gap: 15px; 
        align-items: flex-end; /* Alinha o bot칚o com a base dos inputs */
        flex-wrap: wrap; 
    }
    
    .form-col { 
        flex: 1; 
        min-width: 150px; 
    }

    /* Estiliza칞칚o dos Labels */
    .form-col label { 
        display: block; 
        margin-bottom: 5px; 
        font-weight: 600; 
        color: #0f2346; /* Azul LicitOn */
        font-size: 0.9rem; 
    }
    
    /* --- O PULO DO GATO: Estilizando os inputs gerados pelo Django --- */
    .form-col input, 
    .form-col select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background-color: #f9f9f9;
        color: #333;
        font-size: 0.95rem;
        height: 42px; /* Altura fixa para alinhar */
        box-sizing: border-box; /* Garante que o padding n칚o estoure a largura */
    }

    .form-col input:focus, 
    .form-col select:focus {
        border-color: #0f2346;
        outline: none;
        background-color: #fff;
    }

    /* Bot칚o Filtrar */
    .btn-gerar { 
        background-color: #0f2346; /* var(--azul-profundo) */
        color: white; 
        border: none; 
        padding: 0 25px; /* Padding lateral */
        border-radius: 5px; 
        cursor: pointer; 
        font-weight: bold; 
        height: 42px; /* Mesma altura dos inputs */
        transition: background 0.2s;
    }
    
    .btn-gerar:hover { background-color: #1a3a6e; }

    /* Bot칚o PDF */
    .btn-imprimir { 
        background-color: #6c757d; 
        color: white; 
        border: none; 
        padding: 8px 16px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: bold; 
        display: inline-flex; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 15px;
        font-size: 0.9rem;
    }
    .btn-imprimir:hover { background-color: #5a6268; }
    
    /* Cards de Resumo */
    .report-summary {
        display: flex; gap: 20px; margin-bottom: 20px;
    }
    .summary-box {
        background: white; padding: 15px 25px; border-radius: 8px; 
        border-left: 4px solid #0f2346; /* var(--ciano-eletrico) ou azul */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex: 1;
    }

    /* Tabela */
    .report-table { width: 100%; border-collapse: collapse; background: white; }
    .report-table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-size: 0.85rem; text-transform: uppercase; color: #555; }
    .report-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
    
    .badge {
        padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background: #eee; color: #333;
    }

    /* T칤tulo que s칩 aparece no PDF (Escondido na tela) */
    .pdf-header-only { display: none; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #0f2346; padding-bottom: 10px; }
</style>


<div class="report-controls">
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <h3 style="color: #0f2346; margin: 0;">游늵 Gerador de Relat칩rios</h3>
    </div>
    
    <form method="GET">
        <div class="form-row">
            <div class="form-col">{{ form.data_inicio.label_tag }} {{ form.data_inicio }}</div>
            <div class="form-col">{{ form.data_fim.label_tag }} {{ form.data_fim }}</div>
            <div class="form-col">{{ form.status.label_tag }} {{ form.status }}</div>
            <div class="form-col" style="flex: 2;">{{ form.cliente.label_tag }} {{ form.cliente }}</div> <div class="form-col" style="flex: 0;">
                <button type="submit" class="btn-gerar">游댌 Filtrar</button>
            </div>
        </div>
    </form>
</div>

{% if filtro_ativo %}

    <button onclick="gerarPDF()" class="btn-imprimir">
        游늯 Baixar Relat칩rio em PDF
    </button>

    <div id="conteudo-pdf" style="background: white; padding: 10px;">
        
        <div class="pdf-header-only">
            <h2 style="color: #0f2346; margin: 0;">LicitOn - Relat칩rio Gerencial</h2>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #666;">Gerado em: {% now "d/m/Y H:i" %}</p>
        </div>

        <div class="report-summary">
            <div class="summary-box">
                <small style="color: #666; font-weight: bold;">ITENS ENCONTRADOS</small>
                <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">{{ total_itens }}</div>
            </div>
            <div class="summary-box" style="border-left-color: #28a745;">
                <small style="color: #666; font-weight: bold;">VALOR TOTAL (DO PER칈ODO)</small>
                <div style="font-size: 1.8rem; font-weight: bold; color: #28a745; margin-top: 5px;">
                    R$ {{ total_valor|floatformat:2|intcomma }}
                </div>
            </div>
        </div>

        <table class="report-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente / 칍rg칚o</th>
                    <th>Edital</th>
                    <th>Status</th>
                    <th style="text-align: right;">Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for lic in licitacoes %}
                <tr>
                    <td>{{ lic.data_abertura|date:"d/m/Y" }}</td>
                    <td>{{ lic.cliente.nome|default:lic.orgao }}</td>
                    <td>{{ lic.titulo }}</td>
                    <td>
                        <span class="badge">{{ lic.get_status_display }}</span>
                    </td>
                    <td style="text-align: right;">
                        {% if lic.valor_estimado %}R$ {{ lic.valor_estimado|floatformat:2|intcomma }}{% else %}-{% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #777;">
                        Nenhum registro encontrado com esses filtros.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px; color: #888; background: white; border-radius: 8px;">
        <p style="font-size: 1.1rem;">游녡 Use os filtros acima para gerar um relat칩rio.</p>
    </div>
{% endif %}

<script>
    function gerarPDF() {
        // Seleciona o conte칰do
        const elemento = document.getElementById('conteudo-pdf');
        
        // Torna o cabe칞alho do PDF vis칤vel temporariamente para a "foto"
        const header = elemento.querySelector('.pdf-header-only');
        header.style.display = 'block';

        const opt = {
            margin:       10,
            filename:     'relatorio_liciton_{% now "Y-m-d" %}.pdf', // Nome do arquivo com data
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 }, // Melhora resolu칞칚o
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        // Gera o PDF e depois esconde o cabe칞alho de volta
        html2pdf().set(opt).from(elemento).save().then(function(){
            header.style.display = 'none';
        });
    }
</script>

{% endblock %}