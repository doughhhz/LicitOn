{% extends 'base.html' %}
{% load humanize %}

{% block title %}Minhas Licita√ß√µes - LicitOn{% endblock %}

{% block content %}
<style>
    /* --- Estilos Gerais da Tabela --- */
    .table-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .header-action {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
    }
    .btn-novo {
        background-color: var(--ciano-eletrico); color: white; padding: 10px 20px;
        border-radius: 8px; text-decoration: none; font-weight: bold; transition: 0.3s;
    }
    .btn-novo:hover { background-color: var(--azul-profundo); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; color: #666; font-size: 0.85rem; border-bottom: 2px solid #f0f0f0; }
    td { padding: 15px; border-bottom: 1px solid #f0f0f0; color: #333; font-size: 0.95rem; vertical-align: middle; }
    tr:hover { background-color: #f9f9f9; }

    /* Badges de Status */
    .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
    .status-novo { background-color: #e3f2fd; color: #0d47a1; }
    .status-ganhamos { background-color: #d4edda; color: #155724; }
    .status-perdemos { background-color: #f8d7da; color: #721c24; }
    .status-analise { background-color: #fff3cd; color: #856404; }
    .status-padrao { background-color: #e2e3e5; color: #383d41; }

    /* --- BARRA DE PESQUISA --- */
    .filter-bar {
        background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;
        display: flex; gap: 10px; flex-wrap: wrap; border: 1px solid #e9ecef;
    }
    .filter-input, .filter-select { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 0.9rem; outline: none; }
    .filter-input { flex-grow: 1; min-width: 200px; }
    .btn-filtrar { background-color: var(--azul-profundo); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-limpar { display: flex; align-items: center; color: #666; text-decoration: none; font-size: 0.9rem; padding: 0 10px; }
    .btn-limpar:hover { color: #dc3545; }

    /* --- BOT√ïES DE DOCUMENTOS --- */
    .btn-group-docs {
        display: flex;
        gap: 5px;
        flex-direction: column; /* Empilha se tiver muitos */
    }
    
    .btn-docs {
        background-color: white;
        border: 1px solid #ddd;
        color: #555;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        width: fit-content;
    }
    .btn-docs:hover {
        background-color: #f0f0f0;
        border-color: #bbb;
        color: #333;
    }
    .btn-edital-main {
        border-color: var(--ciano-eletrico);
        color: var(--azul-profundo);
    }

    /* --- MODAL ESTILO VIDRO --- */
    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-active {
        display: flex !important;
        opacity: 1;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        position: relative;
    }

    .modal-active .modal-content {
        transform: scale(1);
    }

    .doc-list {
        list-style: none;
        padding: 0;
        margin-top: 15px;
        max-height: 300px; /* Scroll se tiver muitos anexos */
        overflow-y: auto;
    }

    .doc-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: 0.2s;
    }
    .doc-item:hover { background-color: #f9fbfd; border-radius: 8px; }
    .doc-item:last-child { border-bottom: none; }
    
    .doc-icon { font-size: 1.5rem; margin-right: 12px; }
    .doc-info { flex-grow: 1; }
    .doc-name { font-weight: bold; display: block; color: #333; font-size: 0.9rem; }
    .doc-type { font-size: 0.75rem; color: #888; text-transform: uppercase; }

    .btn-close-modal {
        position: absolute; top: 15px; right: 15px;
        background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;
    }
    .btn-close-modal:hover { color: #333; }

</style>

<div class="table-container">
    <div class="header-action">
        <h2>üìÇ Todas as Licita√ß√µes</h2>
        <a href="{% url 'criar_licitacao' %}" class="btn-novo">+ Nova Licita√ß√£o</a>
    </div>

    <form method="GET" class="filter-bar">
        <input type="text" name="q" class="filter-input" placeholder="Buscar por Edital, √ìrg√£o ou Objeto..." value="{{ busca_atual|default:'' }}">
        <select name="status" class="filter-select">
            <option value="">Todos os Status</option>
            <option value="novo" {% if status_atual == 'novo' %}selected{% endif %}>Novo Edital</option>
            <option value="analise" {% if status_atual == 'analise' %}selected{% endif %}>Em An√°lise</option>
            <option value="participando" {% if status_atual == 'participando' %}selected{% endif %}>Aguardando Disputa</option>
            <option value="ganhamos" {% if status_atual == 'ganhamos' %}selected{% endif %}>Ganhamos üèÜ</option>
            <option value="perdemos" {% if status_atual == 'perdemos' %}selected{% endif %}>Perdemos</option>
        </select>
        <select name="modalidade" class="filter-select">
            <option value="">Todas as Modalidades</option>
            <option value="pregao_eletronico" {% if modalidade_atual == 'pregao_eletronico' %}selected{% endif %}>Preg√£o Eletr√¥nico</option>
            <option value="pregao_presencial" {% if modalidade_atual == 'pregao_presencial' %}selected{% endif %}>Preg√£o Presencial</option>
            <option value="concorrencia" {% if modalidade_atual == 'concorrencia' %}selected{% endif %}>Concorr√™ncia</option>
            <option value="dispensa" {% if modalidade_atual == 'dispensa' %}selected{% endif %}>Dispensa</option>
        </select>
        <button type="submit" class="btn-filtrar">üîç Filtrar</button>
        {% if busca_atual or status_atual or modalidade_atual %}
            <a href="{% url 'listar_licitacoes' %}" class="btn-limpar">‚úñ Limpar</a>
        {% endif %}
    </form>

    {% if licitacoes %}
    <table>
        <thead>
            <tr>
                <th>EDITAL</th>
                <th>√ìRG√ÉO / CLIENTE</th>
                <th>DATA DISPUTA</th>
                <th>VALOR ESTIMADO</th>
                <th>STATUS</th>
                <th>ARQUIVOS</th> <th>A√á√ïES</th>
            </tr>
        </thead>
        <tbody>
            {% for licitacao in licitacoes %}
            <tr>
                <td style="font-weight: bold; color: var(--azul-profundo);">{{ licitacao.titulo }}</td>
                
                <td>
                    {% if licitacao.cliente %}
                        <strong style="color: var(--azul-profundo);">{{ licitacao.cliente.nome }}</strong>
                    {% else %}
                        {{ licitacao.orgao|default:"-" }}
                    {% endif %}
                </td>
                
                <td>{{ licitacao.data_abertura|date:"d/m/Y H:i" }}</td>
                
                <td>
                    {% if licitacao.valor_estimado %}
                        R$ {{ licitacao.valor_estimado|floatformat:2|intcomma }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                
                <td>
                    <span class="badge 
                        {% if licitacao.status == 'novo' %}status-novo
                        {% elif licitacao.status == 'ganhamos' %}status-ganhamos
                        {% elif licitacao.status == 'perdemos' %}status-perdemos
                        {% elif licitacao.status == 'analise' %}status-analise
                        {% else %}status-padrao{% endif %}">
                        {{ licitacao.get_status_display }}
                    </span>
                </td>

                <td>
                    <div class="btn-group-docs">
                        {% if licitacao.arquivo %}
                            <a href="{{ licitacao.arquivo.url }}" target="_blank" class="btn-docs btn-edital-main" title="Baixar Edital">
                                üìú Edital Principal
                            </a>
                        {% elif licitacao.url_origem %}
                            <a href="{{ licitacao.url_origem }}" target="_blank" class="btn-docs btn-edital-main" title="Abrir Link Original">
                                üîó Link Edital
                            </a>
                        {% endif %}

                        {% if licitacao.anexos.exists %}
                            <button class="btn-docs" onclick="abrirModal('modal-{{ licitacao.id }}')">
                                üìé Anexos ({{ licitacao.anexos.count }})
                            </button>
                        {% endif %}
                    </div>

                    <div id="modal-{{ licitacao.id }}" class="modal-backdrop" onclick="fecharNoFundo(event, 'modal-{{ licitacao.id }}')">
                        <div class="modal-content">
                            <button class="btn-close-modal" onclick="fecharModal('modal-{{ licitacao.id }}')">&times;</button>
                            
                            <h3 style="color: var(--azul-profundo); margin-bottom: 5px;">Arquivos do Processo</h3>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">{{ licitacao.titulo }}</p>

                            <ul class="doc-list">
                                {% for anexo in licitacao.anexos.all %}
                                <li>
                                    <a href="{% if anexo.arquivo %}{{ anexo.arquivo.url }}{% else %}{{ anexo.url }}{% endif %}" 
                                       target="_blank" style="text-decoration: none;">
                                        <div class="doc-item">
                                            <span class="doc-icon">
                                                {% if anexo.arquivo %}üìÑ{% else %}üîó{% endif %}
                                            </span>
                                            <div class="doc-info">
                                                <span class="doc-name">{{ anexo.descricao }}</span>
                                                <span class="doc-type">
                                                    {% if anexo.arquivo %}Arquivo Interno{% else %}Link Externo{% endif %}
                                                </span>
                                            </div>
                                            <span style="color: var(--ciano-eletrico);">‚¨á Acessar</span>
                                        </div>
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </td>

                <td>
                    <a href="{% url 'editar_licitacao' licitacao.id %}" style="color: var(--ciano-eletrico); font-weight: bold; text-decoration: none;">
                        Ver / Editar
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="text-align: center; color: #666; padding: 20px;">Nenhuma licita√ß√£o encontrada.</p>
    {% endif %}
</div>

<script>
    function abrirModal(modalId) {
        document.getElementById(modalId).classList.add('modal-active');
    }

    function fecharModal(modalId) {
        document.getElementById(modalId).classList.remove('modal-active');
    }

    // Fecha se clicar na parte escura (fora da caixa branca)
    function fecharNoFundo(event, modalId) {
        if (event.target.id === modalId) {
            fecharModal(modalId);
        }
    }
</script>

{% endblock %}