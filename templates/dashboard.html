{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard - LicitOn{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Cards do Topo */
    .kpi-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;
    }
    .kpi-card {
        background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--azul-profundo);
    }
    .kpi-title { font-size: 0.9rem; color: #666; margin-bottom: 10px; font-weight: bold; text-transform: uppercase; }
    .kpi-value { font-size: 1.8rem; font-weight: bold; color: #333; }

    /* Layout Gr√°fico + Agenda */
    .dashboard-grid {
        display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; /* Coluna da agenda √© maior */
    }
    
    /* Se a tela for pequena (celular), fica um embaixo do outro */
    @media (max-width: 900px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }

    .box-container {
        background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .box-title { color: var(--azul-profundo); margin-bottom: 20px; font-size: 1.1rem; }

    /* Estilo da Tabela Pequena */
    .mini-table { width: 100%; border-collapse: collapse; }
    .mini-table td { padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .mini-table tr:last-child td { border-bottom: none; }
    .date-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; }
</style>

<div class="kpi-grid">
    <div class="kpi-card" style="border-color: #4facfe;">
        <div class="kpi-title">Total de Processos</div>
        <div class="kpi-value">{{ total_licitacoes }}</div>
    </div>
    <div class="kpi-card" style="border-color: #00f2fe;">
        <div class="kpi-title">Em Andamento</div>
        <div class="kpi-value">{{ em_andamento }}</div>
    </div>
    <div class="kpi-card" style="border-color: #43e97b;">
        <div class="kpi-title">Total Ganho (R$)</div>
        <div class="kpi-value">R$ {{ total_ganho|floatformat:2|intcomma }}</div>
    </div>
</div>

<div class="dashboard-grid">
    
    <div class="box-container">
        <h3 class="box-title">üìä Performance (Funil)</h3>
        <div style="height: 250px; display: flex; justify-content: center;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <div class="box-container">
        <h3 class="box-title">üìÖ Pr√≥ximas Disputas</h3>
        
        {% if proximas_disputas %}
        <table class="mini-table">
            {% for licitacao in proximas_disputas %}
            <tr>
                <td width="20%"><span class="date-badge">{{ licitacao.data_abertura|date:"d/m H:i" }}</span></td>
                <td>
                    <strong>{{ licitacao.cliente.nome|default:licitacao.orgao }}</strong><br>
                    <span style="color: #666; font-size: 0.85rem;">{{ licitacao.titulo }}</span>
                </td>
                <td style="text-align: right;">
                    <a href="{% url 'editar_licitacao' licitacao.id %}" style="text-decoration: none; color: var(--ciano-eletrico); font-weight: bold;">Ver &rarr;</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
            <p style="color: #999; font-style: italic;">Nenhuma disputa agendada para os pr√≥ximos dias.</p>
        {% endif %}
    </div>

</div>

<script>
    // TRUQUE: Colocamos entre aspas para o editor n√£o marcar erro
    // E usamos Number() para converter de volta para n√∫mero
    const ganhas = Number("{{ ganhas_count|default:0 }}");
    const perdidas = Number("{{ perdidas_count|default:0 }}");
    const andamento = Number("{{ andamento_count|default:0 }}");

    const ctx = document.getElementById('statusChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ganhamos üèÜ', 'Perdemos ‚ùå', 'Em Andamento ‚è≥'],
            datasets: [{
                // Agora usamos as vari√°veis limpas do JS
                data: [ganhas, perdidas, andamento],
                backgroundColor: [
                    '#28a745', // Verde
                    '#dc3545', // Vermelho
                    '#ffc107'  // Amarelo
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}